Guacamole will provide users with a Graphical User Interface to interact with Kali Linux machine.

We will begin by hardening the Kali Linux machine:
Install the following firewall service:
  kali@kali:~$ sudo apt-get install ufw fail2ban
Configure ufw to allow port 22 for SSH connections and port 55555 for Guacamole connections
  kali@kali:~$ sudo ufw allow 22
  kali@kali:~$ sudo ufw allow 3389
  kali@kali:~$ sudo ufw allow 55555

Guacamole Install:
Download the .war and .tar file from the following sites:
  kali@kali:~$ wget https://mirrors.estointernet.in/apache/guacamole/1.4.0/source/guacamole-server-1.4.0.tar.gz
  kali@kali:~$ wget https://mirrors.estointernet.in/apache/guacamole/1.4.0/binary/guacamole-1.4.0.war
    https://mirrors.estointernet.in/apache/guacamole/1.4.0/source/guacamole-server-1.4.0.tar.gz
    https://mirrors.estointernet.in/apache/guacamole/1.4.0/binary/guacamole-1.4.0.war

Download Guacamole prerequisites
  kali@kali:~$ sudo apt-get install build-essential htop libcairo2-dev libjpeg-dev libpng-dev libossp-uuid-dev tomcat9 freerdp2-dev libpango1.0-dev
  libssh2-1-dev libtelnet-dev libvncserver-dev libpulse-dev libssl-dev libvorbis-dev

Edit the /etc/tomcat9/server.xml file and change the Connector port to 55555
  <Connector port="55555" protocol="HTTP/1.1"

Install the RDP service:
  kali@kali:~$ sudo apt install xrdp

Edit the following file /etc/X11/Xwrapper.config and change the value of allowed_users to anybody
  allowed_users=anybody

Set xrdp services to start automatically and enable the service
  kali@kali:~$ sudo update-rc.d xrdp enable (If a Perl Error is received review https://www.cyberciti.biz/faq/perl-warning-setting-locale-failed-in-debian-ubuntu/)
  kali@kali:~$ sudo systemctl enable xrdp-sesman.service
  kali@kali:~$ sudo service xrdp start
  kali@kali:~$ sudo service xrdp-sesman start

Extract the source:
  kali@kali:~$ tar xvf guacamole-server-1.4.0.tar.gz

cd into the guacamole directory and build and install Guacamole:
  kali@kali:~$ CFLAGS="-Wno-error" ./configure --with-init-dir=/etc/init.d
  kali@kali:~$ make -j4
  kali@kali:~$ sudo make install
  kali@kali:~$ sudo ldconfig
  kali@kali:~$ sudo update-rc.d guacd defaults

Create a guacamole subdirectory within /etc, then create a guacamole.properties file:
  kali@kali:~$ sudo mkdir /etc/guacamole
  #Hostname and Port of Guacamole Proxy
  guacd-hostname:  localhost
  guacd-port:      4822

Create a user-mapping.xml file containg the following:
  <user-mapping>
        <authorize username="kali" password="kali">
                <connection name="RDP Connection"> <protocol>rdp</protocol> <param name="hostname">localhost</param> <param name="port">3389</param> </connection>
                <connection name="SSH Connection"> <protocol>ssh</protocol> <param name="hostname">localhost</param> <param name="port">22</param> </connection>
        </authorize>
  </user-mapping>

Move the .war file to the /var/lib/tomcat9/webapps folder:
  kali@kali:~$ sudo mv guacamole-1.4.0.war /var/lib/tomcat9/webapps/guacamole.war
  
Restart both guacamole and tomcat
  kali@kali:~$ sudo service guacd restart
  kali@kali:~$ sudo service tomcat9 restart
  
Now copy the authentication information into the Guacamole client directory:
  kali@kali:~$ sudo mkdir /usr/share/tomcat9/.guacamole
  kali@kali:~$ ln -s /etc/guacamole/guacamole.properties /usr/share/tomcat9/.guacamole
